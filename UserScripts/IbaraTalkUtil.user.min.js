// ==UserScript==
// @name        IbaraTalkUtil
// @namespace   https://twitter.com/11powder
// @description 交流ってスバラシティ
// @include     http://lisge.com/ib/talk.php*
// @version     1.0.6
// @updateURL   https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraTalkUtil.min.user.js
// @downloadURL https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraTalkUtil.min.user.js
// @grant       none
// ==/UserScript==
//
// リアルタイム交流ページに以下の機能を追加します。
// ・動的プレビュー
// ・tabキー押下時などに綴じタグの自動補完
// ・BRタグの自動置換
// ・Ctrl+Shift+Enterによる発言送信
!function(d){"use strict";if(document.getElementById("CL1")){var e,i,p=function(){var t,n={"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"},e="[";for(var r in n)n.hasOwnProperty(r)&&(e+=r);return e+="]",t=new RegExp(e,"g"),function(e){return(e=e?""+e:"").replace(t,function(e){return n[e]})}}(),h=function(e){return e?e.replace(/(?:\r\n|\r|\n)/g,"<BR>"):e},o=((e=function(){this.ID=0}).prototype.setDelay=function(t,e){if(this.ID&&clearTimeout(this.ID),3<=arguments.length){var n=Array.prototype.slice.call(arguments,2);this.ID=setTimeout(function(e){t.apply(null,e),this.ID=0},e,n)}else this.ID=setTimeout(function(){t.prototype.call(null),this.ID=0},e)},e),g=(i=function(e,t,n,r,a,i){var s;switch(t.toUpperCase()){case"F":s="span";break;case"B":case"I":case"S":case"U":s=t}return n?S("<{TYPE} class='F{SIZE}'>{VALUE}</{TYPE}>",{TYPE:s,SIZE:n,VALUE:r}):S("<{TYPE}>{VALUE}</{TYPE}>",{TYPE:s,VALUE:r})},function(e){for(var t=p(e),n=new RegExp(p("<(F(?=\\d)|B|I|S|U)([1-7]?)>(.*?)</\\1\\2>"),"ig"),r=h(t).replace(/&lt;br&gt;/gi,"<BR>"),a=0;a<2;a++)r=r.replace(/&lt;([1-9][0-9]?D[1-9][0-9]?[0-9]?)&gt;/i,"<span class='DX'>【 <b>$1</b>：[賽の目] 】</span>");return function(e,t,n){for(var r=e.toString();;){if(!t.test(r))return r;r=r.replace(t,n)}}(r,n,i)}),t=function(){function e(e,t){var n,r="<div class='{CNT_CLASS_NAME}'><table cellpadding='0' cellspacing='0' class='SE0' style='width:440px;'><tr valign='TOP'><td width='70'><img src='{ICON_URL}' class='RE2' alt='RE'></td><td class='F3'>{RESPONSE}<a href='#'><span class='Y3'>{SENDER_NAME}({SENDER_ENO})</span></a><br>{SAY_HTML}</td></tr></table></div>";return S("<div class='Preview'><div class='Y3'>《{PREVIEW_TYPE}プレビュー》</div>{INNER_HTML}</div>",{INNER_HTML:r=S(r=t?(n="SE4",S(r,{RESPONSE:"<a href='#' class='F1'>＞{ANKER_INFO} <br></a>"})):(n="SE3",S(r,{RESPONSE:""})),{CNT_CLASS_NAME:n,SENDER_ENO:e})})}var r=d("#CL1 img.IC").map(function(e,t){return t.getAttribute("src")}).toArray(),t=(/IBR_KEY=.+?_(\d+)(?:;|$)/.exec(document.cookie)||[])[1]||"",a=e(t),i=e(t,!0);function s(e){var t=d(e.currentTarget).parent(),n="";n="say"!==t.attr("name")?S(i,{ANKER_INFO:"返信"}):a,v({$InsertAfter:t,$Text:t.find(l),$Name:t.find(c),$Icon:t.find(u),Template:n,MaxChars:400,IconUrlArray:r,StyleName:"Say"})}var l="textarea[name^='dt_mes']",c="input[name^='dt_ai']",u="select[name^='dt_ic']";return function(t){var n=new o,e=function(e){n.setDelay(s,t,e)};d(document.body).on("keyup input",l,e).on("keyup input",c,e).on("change",u,e)}}(),n=function(){function a(e){13===e.which&&e.ctrlKey&&e.shiftKey&&(e.preventDefault(),d(this).closest("form").find(e.data.but).first().click())}return function(e,t,n){var r="input[type='submit']"+(n?"[value='"+n+"']":"");t?d(e).find(t).closest("form").find(r):d(e).closest("form").find(r),t?d(e).on("keydown",t,{but:r},a):d(e).on("keydown",{but:r},a)}}(),r=function(){var l="((?:F(?=\\d)|I|S|U)[1-7]?)",c=new RegExp("<"+l+">","gi"),u=new RegExp("</"+l+">","gi");function s(e,t){var n=e.match(c);if(!n)return[];var r=n.map(function(e,t){return e.slice(1,e.length-1)}),a=(e+t).match(u);if(!a)return r;for(var i=a.map(function(e,t){return e.slice(2,e.length-1)}),s=i.length-1;0<=s;s--)for(var l=r.length-1;0<=l;l--)if(i[s]===r[l]){r.splice(l,1);break}return r}var o=new RegExp("<[^>]{0,4}?$"),v=new RegExp("^[^<]{0,4}?>");function n(e){if(9===e.which){if(e.preventDefault(),this.selectionStart!==this.selectionEnd)return void this.setSelectionRange(this.selectionEnd,this.selectionEnd);if(function(e){if(e.selectionStart!==e.selectionEnd)return!1;var t=e.selectionStart,n=e.value.slice(0,t),r=e.value.slice(t),a=new RegExp("<?"+l+">?$","i").exec(n);if(!a)return!1;if(new RegExp("<?/"+l+">?$","i").test(n))return!1;if(/^<[^<>]+?>$/.test(a[0]))return!1;if(o.test(n)&&v.test(r))return!1;var i="<"+a[1]+"></"+a[1]+">";e.value=n.slice(0,-a[0].length)+i+r;var s=t-a[0].length+a[1].length+2;return e.setSelectionRange(s,s),!0}(this))return;!function(e){if(e.selectionStart!==e.selectionEnd)return;var t=e.selectionStart,n=e.value.slice(0,t),r=e.value.slice(t),a=s(n,r);if(0===a.length)return;var i="</"+a[a.length-1]+">";e.value=n+i+r,e.setSelectionRange(t,t+i.length)}(this)}else"/"===e.key&&function(e){if(e.selectionStart<=0||e.selectionStart!==e.selectionEnd)return!1;var t=e.selectionStart,n=e.value.slice(0,t),r=e.value.slice(t);if("<"!==n[t-1])return!1;var a=s(n,r);if(0===a.length)return!1;var i="/"+a[a.length-1]+">";return e.value=n+i+r,e.setSelectionRange(t+1,t+i.length),!0}(this)&&e.preventDefault()}return function(e,t){t?d(e).on("keydown",t,n):d(e).on("keydown",n)}}();!function(e,t){function n(e){var t;d(e.currentTarget).val((t=d(e.currentTarget).val())?t.replace(/<br>/gi,"\r\n"):t)}t?d(e).on("keyup input",t,n):d(e).on("keyup input",n)}(document.body,"textarea[name^='dt_mes']"),n(document.body,"textarea[name^='dt_mes']","発言する"),r(document.body,"textarea[name^='dt_mes']"),t(200)}function S(e,t){var n=e.toString();for(var r in t)void 0!==t[r]&&null!==t[r]&&(n=n.replace(new RegExp("{"+r+"}","g"),t[r].toString()));return n}function m(e){return/^[ \r\n\t]*([\s\S]*?)\s*$/.exec(e)[1]}function N(e,t){var n=t.Values||{};return S(e,d.extend(n,{CHARS_NUM:t.CharsNum,MAX_CHARS_NUM:t.MaxCharsNum,PREVIEW_TYPE:t.PreviewType}))}function v(e){var t,n,r,a=(t=e.$InsertAfter,n=e.StyleName,0===(r=t.next(".PreviewParentBlock")).length&&(r=d("<div class='PreviewParentBlock' name='Preview' />").addClass(n).insertAfter(t)),r),i=m(e.$Text.val());if(0!==i.length){var s=i.length;if(s>e.MaxChars)a.html(N(S("<div class='Preview'><div class='Y3'>《{PREVIEW_TYPE}プレビュー》</div>{INNER_HTML}</div>",{INNER_HTML:"<div class='SE2'>【ERROR】書き込み内容は{MAX_CHARS_NUM}文字以内です！（現在{CHARS_NUM}文字）</div>"}),{CharsNum:s,MaxCharsNum:e.MaxChars,PreviewType:"発言"})).css("display","block");else{var l=m(e.$Name.val());if(8<l.length)a.html(N(S("<div class='Preview'><div class='Y3'>《{PREVIEW_TYPE}プレビュー》</div>{INNER_HTML}</div>",{INNER_HTML:"<div class='Preview'><div class='SE2'>【ERROR】発言者名は{MAX_CHARS_NUM}文字以内です！（現在{CHARS_NUM}文字）</div></div>"}),{CharsNum:l.length,MaxCharsNum:8,PreviewType:"発言"})).css("display","block");else{var c=p(l),u=/^@([\s\S]*?)@/.exec(i);u&&(u[1]&&(c=h(p(u[1]))),i=i.substring(u[0].length));var o=g(i),v=e.$Icon.val(),f="p/nii.png";/^\d+$/.test(v)&&(f=e.IconUrlArray[parseInt(v,10)]);var E=N(e.Template,{CharsNum:s,MaxCharsNum:e.MaxChars,PreviewType:"発言",Values:{ICON_URL:f,SENDER_NAME:c,SAY_HTML:o}});a.html(E).css("display","block")}}}else a.css("display","none")}}(jQuery);
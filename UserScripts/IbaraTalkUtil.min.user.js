// ==UserScript==
// @name        IbaraTalkUtil
// @namespace   https://twitter.com/11powder
// @description 交流ってスバラシティ
// @include     http://lisge.com/ib/talk.php*
// @version     1.0.7.1
// @updateURL   https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraTalkUtil.min.user.js
// @downloadURL https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraTalkUtil.min.user.js
// @grant       none
// ==/UserScript==
!function(p){"use strict";if(document.getElementById("CL1")){var e,a,r,h=function(){var t,n={"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"},e="[";for(var a in n)n.hasOwnProperty(a)&&(e+=a);return e+="]",t=new RegExp(e,"g"),function(e){return(e=e?""+e:"").replace(t,function(e){return n[e]})}}(),E=function(e){return e?e.replace(/(?:\r\n|\r|\n)/g,"<BR>"):e},u=((e=function(){this.ID=0}).prototype.setDelay=function(t,e){if(this.ID&&clearTimeout(this.ID),3<=arguments.length){var n=Array.prototype.slice.call(arguments,2);this.ID=setTimeout(function(e){t.apply(null,e),this.ID=0},e,n)}else this.ID=setTimeout(function(){t.prototype.call(null),this.ID=0},e)},e),l=Object.freeze({F:{tagName:"span",pattern:"F(?=\\d)"},B:{tagName:"b",pattern:"B"},I:{tagName:"i",pattern:"I"},S:{tagName:"s",pattern:"S"},U:{tagName:"u",pattern:"U"}});!function(){var e=[];for(var t in l)e.push(l[t].pattern);var n=e.join("|");a="(?:"+n+")[1-7]?",r="("+n+")([1-7]?)"}();var i,s,t,c,n,g=(i=function(e,t,n,a,r,i){var s=l[t.toUpperCase()].tagName;return n?m("<{TYPE} class='F{SIZE}'>{VALUE}</{TYPE}>",{TYPE:s,SIZE:n,VALUE:a}):m("<{TYPE}>{VALUE}</{TYPE}>",{TYPE:s,VALUE:a})},s=new RegExp(h("<"+r+">(.*?)</\\1\\2>"),"ig"),function(e){for(var t=h(e),n=E(t).replace(/&lt;br&gt;/gi,"<BR>"),a=0;a<2;a++)n=n.replace(/&lt;([1-9][0-9]?D[1-9][0-9]?[0-9]?)&gt;/i,"<span class='DX'>【 <b>$1</b>：[賽の目] 】</span>");return function(e,t,n){for(var a=e.toString();;){if(!t.test(a))return a;a=a.replace(t,n)}}(n,s,i)}),o=(t="<div class='SE3'><table cellpadding='0' cellspacing='0' class='SE0' style='width:900px;'><tr valign='TOP'><td width='70'><img src='p/iba_icon.png' class='RE2' alt='RE'></td><td class='F3'><a><span class='Y4'>IbaraTalkUtilの機能・使い方</span></a><br><div style='margin:10px;'>・入力した発言内容を自動的に解析してプレビューを表示します。<br>・<b class='O3'>Ctrl+Shift+Enterキー</b>を押すと、送信ボタンを押したのと同様にその発言内容を送信します。<br>・<b class='O3'>Tab</b>キーを押すと、欠けている装飾閉じタグ(<b class='Y3'>"+h("<B>, <f4>")+"</b>など)を自動的に補完します。<br>・タグ名(<b class='Y3'>i4, S</b>など)を入力してからTabキーを押すと、指定の装飾タグを自動入力します。<br>　<span class='P3'>例： f5 ⇒ "+h("<f5></f5>")+"</span><br><br>　(hint) 入力自動補完に対応しているタグ名の一覧（小文字可、半角のみ）：<br><b class='Y3'>　"+h("F[1-7] B B[1-7] I I[1-7] S S[1-7] U U[1-7]")+"</b></div></td></tr></table></div>",c=p("<div></div>").html(t).css({position:"absolute","z-index":2}),(n=function(){var e;this.attachedElement=null,this.onClickHandler=(e=this,function(){e.attachedElement===this?(c.hide(),e.attachedElement=null):(c.insertAfter(this).show(),e.attachedElement=this)})}).prototype.Enable=function(e,t){t?p(e).on("click",t,this.onClickHandler):p(e).on("click",this.onClickHandler);var n=this;c.on("click",function(){c.hide(),n.attachedElement=null})},n),d=function(){function e(e,t){var n,a="<div class='{CNT_CLASS_NAME}'><table cellpadding='0' cellspacing='0' class='SE0' style='width:{WIDTH_PX};'><tr valign='TOP'><td width='70'><img src='{ICON_URL}' class='RE2' alt='RE'></td><td class='F3'>{RESPONSE}<a href='#'><span class='Y3'>{SENDER_NAME}({SENDER_ENO})</span></a><br>{SAY_HTML}</td></tr></table></div>";a=t?(n="SE4",m(a,{RESPONSE:"<a class='F1' href='#'>＞{ANKER_INFO} <br></a>"})):(n="SE3",m(a,{RESPONSE:""}));var r="900px";return"２列"==p("#PLSBN3").text().includes&&(r="440px"),m("<div class='Preview'><div class='Y3 PreviewHeader'>《{PREVIEW_TYPE}プレビュー》 <a href='#'> [Help] </a></div>{INNER_HTML}</div>",{INNER_HTML:a=m(a=m(a,{WIDTH_PX:r}),{CNT_CLASS_NAME:n,SENDER_ENO:e})})}var a=p("#CL1 img.IC").map(function(e,t){return t.getAttribute("src")}).toArray(),t=(/IBR_KEY=.+?_(\d+)(?:;|$)/.exec(document.cookie)||[])[1]||"",r=e(t),i=e(t,!0);function s(e){var t=p(e.currentTarget).parent(),n="";n="say"!==t.attr("name")?m(i,{ANKER_INFO:"返信"}):r,b({$InsertAfter:t,$Text:t.find(l),$Name:t.find(c),$Icon:t.find(o),Template:n,MaxChars:400,IconUrlArray:a,StyleName:"Say"})}var l="textarea[name^='dt_mes']",c="input[name^='dt_ai']",o="select[name^='dt_ic']";return function(t){var n=new u,e=function(e){n.setDelay(s,t,e)};p(document.body).on("keyup input",l,e).on("keyup input",c,e).on("change",o,e),p("form[name='say']").closest("td").css({overflow:"visible","max-width":"700px"}),p("form[name='sch']").closest("td").css("vertical-align","top")}}(),v=function(){function r(e){13===e.which&&e.ctrlKey&&e.shiftKey&&(e.preventDefault(),p(this).closest("form").find(e.data.but).first().click())}return function(e,t,n){var a="input[type='submit']"+(n?"[value='"+n+"']":"");t?p(e).find(t).closest("form").find(a):p(e).closest("form").find(a),t?p(e).on("keydown",t,{but:a},r):p(e).on("keydown",{but:a},r)}}(),f=function(){var c=new RegExp("<("+a+")>","gi"),o=new RegExp("</("+a+")>","gi"),l=new RegExp("<?("+a+")>?$","i"),u=new RegExp("</("+a+")>$","i"),d=new RegExp("<[^>]{0,4}?$"),v=new RegExp("^[^<]{0,4}?>");function s(e,t){var n=e.match(c);if(!n)return[];var a=n.map(function(e,t){return e.slice(1,e.length-1)}),r=(e+t).match(o);if(!r)return a;for(var i=r.map(function(e,t){return e.slice(2,e.length-1)}),s=i.length-1;0<=s;s--)for(var l=a.length-1;0<=l;l--)if(i[s]===a[l]){a.splice(l,1);break}return a}function n(e){if(9===e.which){if(e.preventDefault(),this.selectionStart!==this.selectionEnd)return void this.setSelectionRange(this.selectionEnd,this.selectionEnd);if(function(e){if(e.selectionStart!==e.selectionEnd)return!1;var t=e.selectionStart,n=e.value.slice(0,t),a=e.value.slice(t),r=l.exec(n);if(!r)return!1;if(u.test(n))return!1;if(/^<[^<>]+?>$/.test(r[0]))return!1;if(d.test(n)&&v.test(a))return!1;var i="<"+r[1]+"></"+r[1]+">";e.value=n.slice(0,-r[0].length)+i+a;var s=t-r[0].length+r[1].length+2;return e.setSelectionRange(s,s),!0}(this))return;!function(e){if(e.selectionStart!==e.selectionEnd)return;var t=e.selectionStart,n=e.value.slice(0,t),a=e.value.slice(t),r=s(n,a);if(0===r.length)return;var i="</"+r[r.length-1]+">";e.value=n+i+a,e.setSelectionRange(t,t+i.length)}(this)}else"/"===e.key&&function(e){if(e.selectionStart<=0||e.selectionStart!==e.selectionEnd)return!1;var t=e.selectionStart,n=e.value.slice(0,t),a=e.value.slice(t);if("<"!==n[t-1])return!1;var r=s(n,a);if(0===r.length)return!1;var i="/"+r[r.length-1]+">";return e.value=n+i+a,e.setSelectionRange(t+1,t+i.length),!0}(this)&&e.preventDefault()}return function(e,t){t?p(e).on("keydown",t,n):p(e).on("keydown",n)}}();!function(e,t){function n(e){var t;p(e.currentTarget).val((t=p(e.currentTarget).val())?t.replace(/<br>/gi,"\r\n"):t)}t?p(e).on("keyup input",t,n):p(e).on("keyup input",n)}(document.body,"textarea[name^='dt_mes']"),v(document.body,"textarea[name^='dt_mes']","発言する"),f(document.body,"textarea[name^='dt_mes']"),d(200),(new o).Enable(document.body,".PreviewHeader")}function m(e,t){var n=e.toString();for(var a in t)void 0!==t[a]&&null!==t[a]&&(n=n.replace(new RegExp("{"+a+"}","g"),t[a].toString()));return n}function N(e){return/^[ \r\n\t]*([\s\S]*?)\s*$/.exec(e)[1]}function S(e,t){var n=t.Values||{};return m(e,p.extend(n,{CHARS_NUM:t.CharsNum,MAX_CHARS_NUM:t.MaxCharsNum,PREVIEW_TYPE:t.PreviewType}))}function b(e){var t,n,a,r=(t=e.$InsertAfter,n=e.StyleName,0===(a=t.next(".PreviewParentBlock")).length&&(a=p("<div class='PreviewParentBlock' name='Preview' />").addClass(n).insertAfter(t)),a),i=N(e.$Text.val());if(0!==i.length){var s=i.length;if(s>e.MaxChars)r.html(S(m("<div class='Preview'><div class='Y3 PreviewHeader'>《{PREVIEW_TYPE}プレビュー》 <a href='#'> [Help] </a></div>{INNER_HTML}</div>",{INNER_HTML:"<div class='SE2'>【ERROR】書き込み内容は{MAX_CHARS_NUM}文字以内です！（現在{CHARS_NUM}文字）</div>"}),{CharsNum:s,MaxCharsNum:e.MaxChars,PreviewType:"発言"})).css("display","block");else{var l=N(e.$Name.val());if(8<l.length)r.html(S(m("<div class='Preview'><div class='Y3 PreviewHeader'>《{PREVIEW_TYPE}プレビュー》 <a href='#'> [Help] </a></div>{INNER_HTML}</div>",{INNER_HTML:"<div class='Preview'><div class='SE2'>【ERROR】発言者名は{MAX_CHARS_NUM}文字以内です！（現在{CHARS_NUM}文字）</div></div>"}),{CharsNum:l.length,MaxCharsNum:8,PreviewType:"発言"})).css("display","block");else{var c=h(l),o=/^@([\s\S]*?)@/.exec(i);o&&(o[1]&&(c=E(h(o[1]))),i=i.substring(o[0].length));var u=g(i),d=e.$Icon.val(),v="p/nii.png";/^\d+$/.test(d)&&(v=e.IconUrlArray[parseInt(d,10)]);var f=S(e.Template,{CharsNum:s,MaxCharsNum:e.MaxChars,PreviewType:"発言",Values:{ICON_URL:v,SENDER_NAME:c,SAY_HTML:u}});r.html(f).css("display","block")}}}else r.css("display","none")}}(jQuery);
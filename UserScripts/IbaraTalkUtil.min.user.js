// ==UserScript==
// @name        IbaraTalkUtil
// @namespace   pejuta
// @description 交流ってスバラシティ
// @include     http://lisge.com/ib/talk.php*
// @version     1.0.4
// @grant       none;
// ==/UserScript==
//
// リアルタイム交流ページに以下の機能を追加します。
// ・動的プレビュー
// ・tabキー押下時などに綴じタグの自動補完
// ・BRタグの自動置換
// ・Ctrl+Shift+Enterによる発言送信
!function(p){if(document.getElementById("CL1")){var e,a,E=function(){var t,n={"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"},e="[";for(var r in n)n.hasOwnProperty(r)&&(e+=r);return e+="]",t=new RegExp(e,"g"),function(e){return(e=e?""+e:"").replace(t,function(e){return n[e]})}}(),h=function(e){return e?e.replace(/(?:\r\n|\r|\n)/g,"<BR>"):e},o=((e=function(){this.ID=0}).prototype.setDelay=function(t,e){if(this.ID&&clearTimeout(this.ID),3<=arguments.length){var n=Array.prototype.slice.call(arguments,2);this.ID=setTimeout(function(e){t.apply(null,e),this.ID=0},e,n)}else this.ID=setTimeout(function(){t.prototype.call(null),this.ID=0},e)},e),N=(a=function(e,t,n,r,i,a){var s;switch(t.toUpperCase()){case"F":s="span";break;case"I":case"S":case"U":s=t}return n?g("<{TYPE} class='F{SIZE}'>{VALUE}</{TYPE}>",{TYPE:s,SIZE:n,VALUE:r}):g("<{TYPE}>{VALUE}</{TYPE}>",{TYPE:s,VALUE:r})},function(e){for(var t=E(e),n=new RegExp(E("<(F(?=\\d)|I|S|U)([1-7]?)>(.*?)</\\1\\2>"),"ig"),r=h(t).replace(/&lt;br&gt;/gi,"<BR>"),i=0;i<2;i++)r=r.replace(/&lt;([1-9][0-9]?D[1-9][0-9]?[0-9]?)&gt;/i,"<span class='DX'>【 <b>$1</b>：[賽の目] 】</span>");return function(e,t,n){for(var r=e.toString();;){if(!t.test(r))return r;r=r.replace(t,n)}}(r,n,a)}),t=function(){function e(e,t){var n,r="<div class='{CNT_CLASS_NAME}'><table cellpadding='0' cellspacing='0' class='SE0' style='width:440px;'><tr valign='TOP'><td width='70'><img src='{ICON_URL}' class='RE2' alt='RE'></td><td class='F3'>{RESPONSE}<a href='#'><span class='Y3'>{SENDER_NAME}({SENDER_ENO})</span></a><br>{SAY_HTML}</td></tr></table></div>";return g("<div class='Preview'><div class='Y3'>《{PREVIEW_TYPE}プレビュー》</div>{INNER_HTML}</div>",{INNER_HTML:r=g(r=t?(n="SE4",g(r,{RESPONSE:"<a href='#' class='F1'>＞{ANKER_INFO} <br></a>"})):(n="SE3",g(r,{RESPONSE:""})),{CNT_CLASS_NAME:n,SENDER_ENO:e})})}var r=p("#CL1 img.IC").map(function(e,t){return t.getAttribute("src")}).toArray(),t=(/IBR_KEY=.+?_(\d+)(?:;|$)/.exec(document.cookie)||[])[1]||"",i=e(t),a=e(t,!0);function s(e){var t=p(e.currentTarget).parent(),n="";n="say"!==t.attr("name")?g(a,{ANKER_INFO:"返信"}):i,v({$InsertAfter:t,$Text:t.find(l),$Name:t.find(c),$Icon:t.find(u),Template:n,MaxChars:400,IconUrlArray:r,StyleName:"Say"})}var l="textarea[name^='dt_mes']",c="input[name^='dt_ai']",u="select[name^='dt_ic']";return function(t){var n=new o,e=function(e){n.setDelay(s,t,e)};p(document.body).on("keyup input",l,e).on("keyup input",c,e).on("change",u,e)}}(),n=function(){function i(e){13===e.which&&e.ctrlKey&&e.shiftKey&&(e.preventDefault(),p(this).closest("form").find(e.data.but).first().click())}return function(e,t,n){var r="input[type='submit']"+(n?"[value='"+n+"']":"");t?p(e).find(t).closest("form").find(r):p(e).closest("form").find(r),t?p(e).on("keydown",t,{but:r},i):p(e).on("keydown",{but:r},i)}}(),r=function(){var d=/<?((?:F(?=\d)|I|S|U)[1-7]?)>?$/i,f=/<?\/((?:F(?=\d)|I|S|U)[1-7]?)>?$/i,l=/<((?:F(?=\d)|I|S|U)[1-7]?)>/gi,c=/<\/((?:F(?=\d)|I|S|U)[1-7]?)>/gi,E=/<(\D\d?)>/,u=/<\/(\D\d?)>/;function h(e,t){var n=e.match(l);if(!n)return null;var r=(e+t).match(c);if(r){for(var i=r.length-1;0<=i;i--)for(var a=new RegExp("<"+u.exec(r[i])[1]+">","i"),s=n.length-1;0<=s;s--)if(a.test(n[s])){n.splice(s,1);break}if(0===n.length)return null}return E.exec(n[n.length-1])[1]}return function(e,t){function n(e){var t=this.selectionStart,n=this.value.slice(0,t),r=this.value.slice(t);if(9===e.which){if(e.preventDefault(),this.selectionStart!==this.selectionEnd)return void this.setSelectionRange(this.selectionEnd,this.selectionEnd);var i,a,s,l=n.slice(4<=t?t-4:0,t),c=d.exec(l);if(c&&!f.test(l)){if(E.test(c[0])){if(!(o=h(n,r))||o!==c[1])return}else if(E.test(l.slice(-3)+r.slice(0,2)))return;i=n.slice(0,-l.length)+l.replace(d,"<$1></$1>")+r,a=s=t-c[0].length+c[1].length+2}else{if(!(o=h(n,r)))return;var u="</"+o+">";i=n+u+r,s=(a=t)+u.length}this.value=i,this.setSelectionRange(a,s)}else{if("/"!==e.key)return;if(this.selectionStart!==this.selectionEnd)return;var o;if("<"!==n.slice(t-1,t))return;if(!(o=h(n,r)))return;var v="/"+o+">";this.value=n+v+r,this.setSelectionRange(t+1,t+v.length),e.preventDefault()}}t?p(e).on("keydown",t,n):p(e).on("keydown",n)}}();!function(e,t){function n(e){var t;p(e.currentTarget).val((t=p(e.currentTarget).val())?t.replace(/<br>/gi,"\r\n"):t)}t?p(e).on("keyup input",t,n):p(e).on("keyup input",n)}(document.body,"textarea[name^='dt_mes']"),n(document.body,"textarea[name^='dt_mes']","発言する"),r(document.body,"textarea[name^='dt_mes']"),t(200)}function g(e,t){var n=e.toString();for(var r in t)void 0!==t[r]&&null!==t[r]&&(n=n.replace(new RegExp("{"+r+"}","g"),t[r].toString()));return n}function m(e){return/^[ \r\n\t]*([\s\S]*?)\s*$/.exec(e)[1]}function S(e,t){var n=t.Values||{};return g(e,p.extend(n,{CHARS_NUM:t.CharsNum,MAX_CHARS_NUM:t.MaxCharsNum,PREVIEW_TYPE:t.PreviewType}))}function v(e){var t,n,r,i=(t=e.$InsertAfter,n=e.StyleName,0===(r=t.next(".PreviewParentBlock")).length&&(r=p("<div class='PreviewParentBlock' name='Preview' />").addClass(n).insertAfter(t)),r),a=m(e.$Text.val());if(0!==a.length){var s=a.length;if(s>e.MaxChars)i.html(S(g("<div class='Preview'><div class='Y3'>《{PREVIEW_TYPE}プレビュー》</div>{INNER_HTML}</div>",{INNER_HTML:"<div class='SE2'>【ERROR】書き込み内容は{MAX_CHARS_NUM}文字以内です！（現在{CHARS_NUM}文字）</div>"}),{CharsNum:s,MaxCharsNum:e.MaxChars,PreviewType:"発言"})).css("display","block");else{var l=m(e.$Name.val());if(8<l.length)i.html(S(g("<div class='Preview'><div class='Y3'>《{PREVIEW_TYPE}プレビュー》</div>{INNER_HTML}</div>",{INNER_HTML:"<div class='Preview'><div class='SE2'>【ERROR】発言者名は{MAX_CHARS_NUM}文字以内です！（現在{CHARS_NUM}文字）</div></div>"}),{CharsNum:l.length,MaxCharsNum:8,PreviewType:"発言"})).css("display","block");else{var c=E(l),u=/^@([\s\S]*?)@/.exec(a);u&&(u[1]&&(c=h(E(u[1]))),a=a.substring(u[0].length));var o=N(a),v=e.$Icon.val(),d="p/nii.png";/^\d+$/.test(v)&&(d=e.IconUrlArray[parseInt(v,10)]);var f=S(e.Template,{CharsNum:s,MaxCharsNum:e.MaxChars,PreviewType:"発言",Values:{ICON_URL:d,SENDER_NAME:c,SAY_HTML:o}});i.html(f).css("display","block")}}}else i.css("display","none")}}(jQuery);